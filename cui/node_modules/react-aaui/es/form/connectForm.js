import _objectWithoutProperties from 'babel-runtime/helpers/objectWithoutProperties';
import _classCallCheck from 'babel-runtime/helpers/classCallCheck';
import _possibleConstructorReturn from 'babel-runtime/helpers/possibleConstructorReturn';
import _inherits from 'babel-runtime/helpers/inherits';
import _extends from 'babel-runtime/helpers/extends';
import _Object$keys from 'babel-runtime/core-js/object/keys';
import { PureComponent, createElement } from 'react';

import Store from './store';
import getDisplayName from '../shared/getDisplayName';
import { identity, reduceReducers } from '../shared/utils';
import { ValidationResult, ruleRunner } from './validation';
import reducer, { setValue, setError } from './module';
import { FormFieldPropTypes, FormStorePropTypes } from './types';
import { aauiL10nPropTypes } from '../shared/types';

var aauiFormStore = _Object$keys(FormStorePropTypes)[0];
var FormFieldConfig = {
  /* eslint-disable no-unused-vars */
  validator: function validator(_ref) {
    var l10n = _ref.l10n;
    return function (validationResult) {
      return validationResult;
    };
  },
  parser: identity,
  formatter: identity
};
var connectForm = function connectForm() {
  var formFieldConfig = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  return function (WrappedComponent) {
    var connectDisplayName = 'Connect(' + getDisplayName(WrappedComponent) + ')';
    var propTypes = _extends({}, FormFieldPropTypes, aauiL10nPropTypes);

    var Connect = function (_PureComponent) {
      _inherits(Connect, _PureComponent);

      function Connect(props, context) {
        _classCallCheck(this, Connect);

        var _this = _possibleConstructorReturn(this, _PureComponent.call(this, props, context));

        _this.onValidate = function (value) {
          var _this$validate = _this.validate(value),
              errMsg = _this$validate.errMsg;

          _this.setError(errMsg);
        };

        _this.setValue = function (value) {
          _this.store.dispatch(setValue({
            name: _this.props.name,
            value: value
          }));
        };

        _this.setError = function (value) {
          _this.store.dispatch(setError({
            name: _this.props.name,
            value: value
          }));
        };

        _this.setWrappedComponentInstance = function (ref) {
          _this.wrappedComponentInstance = ref;
        };

        _this.getApi = function () {
          return {
            l10n: _this.l10n,
            onValidate: _this.onValidate,
            setValue: _this.setValue,
            setError: _this.setError
          };
        };

        _this.validate = function (value) {
          var _this$props = _this.props,
              name = _this$props.name,
              required = _this$props.required,
              validator = _this$props.validator,
              parser = _this$props.parser,
              _this$props$rules = _this$props.rules,
              rules = _this$props$rules === undefined ? '' : _this$props$rules,
              rest = _objectWithoutProperties(_this$props, ['name', 'required', 'validator', 'parser', 'rules']);

          var validators = [];

          validators.push(ruleRunner);

          // Here is for your custom validation function
          if (validator && typeof validator === 'function') {
            validators.push(validator);
          }

          var chain = validators.map(function (validateFunc) {
            return validateFunc(_extends({
              l10n: _this.l10n,
              rules: required ? 'required|' + rules : rules
            }, rest));
          });

          var _reduceReducers = reduceReducers.apply(undefined, chain)(new ValidationResult(name, parser(value), null)),
              errMsg = _reduceReducers.errMsg;

          return {
            name: name,
            value: value,
            errMsg: errMsg
          };
        };

        _this.store = props[aauiFormStore] || context[aauiFormStore] || new Store();
        _this.l10n = props.aauiL10n || context.aauiL10n;
        return _this;
      }

      Connect.prototype.componentWillMount = function componentWillMount() {
        if (!this.unregister) {
          this.unregister = this.store.injectReducer(this.props.name, reducer);
        }

        if (!this.unregisterValidator && this.store.tryInjectValidator) {
          this.unregisterValidator = this.store.tryInjectValidator(this.props.name, this.validate);
        }
      };

      Connect.prototype.componentWillUnmount = function componentWillUnmount() {
        if (this.unregister) {
          this.unregister(this.props.name);
        }

        this.unregister = null;

        if (this.unregisterValidator) {
          this.unregisterValidator(this.props.name);
        }

        this.unregisterValidator = null;
      };

      Connect.prototype.getWrappedComponentInstance = function getWrappedComponentInstance() {
        return this.wrappedComponentInstance;
      };

      Connect.prototype.render = function render() {
        /* eslint-disable no-unused-vars */
        var _props = this.props,
            required = _props.required,
            validator = _props.validator,
            errMsg = _props.errMsg,
            formatter = _props.formatter,
            parser = _props.parser,
            value = _props.value,
            rules = _props.rules,
            rest = _objectWithoutProperties(_props, ['required', 'validator', 'errMsg', 'formatter', 'parser', 'value', 'rules']);

        this.renderedElement = createElement(WrappedComponent, _extends({
          ref: this.setWrappedComponentInstance,
          api: this.getApi(),
          value: errMsg ? value : formatter(value)
        }, rest));

        return this.renderedElement;
      };

      return Connect;
    }(PureComponent);

    Connect.displayName = connectDisplayName;
    Connect.WrappedComponent = WrappedComponent;
    Connect.propTypes = propTypes;
    Connect.contextTypes = _extends({}, FormStorePropTypes, aauiL10nPropTypes);
    Connect.defaultProps = _extends({}, FormFieldConfig, formFieldConfig);

    return Connect;
  };
};

export default connectForm;